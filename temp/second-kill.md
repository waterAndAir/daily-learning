## 秒杀
### 原则
在系统负荷高并发的基础上：
- 数据尽量少：减少给用户返回的数据，减少用户直接访问到服务端的数据
- 请求尽量少：合并css，images，JavaScript
- 路径尽量短：减少中间节点数，将 RPC 服务转为本地函数调用
- 服务分级：保证强依赖，做好弱依赖的服务降级
- 消除单点：把服务无状态化，使其易于水平扩展
- 独立数据库：最好使用独立的数据库
- 设计保护措施

### 业务方面
- 可以限制用户在x秒之内只能提交一次请求，
- 对同一个uid的请求进行计数和限速
- 下单流程和支付流程异步，以12306为例，下单成功后，系统占住库存，45分钟之内支付即可。
- 不同地域分时售票，
- 一旦点击，不管系统是否返回，按钮立刻置灰
- 只显示有/无车票，而不是显示具体票数目

##### 答题
设计答题系统，一方面防止机器人请求，另一方面可以延缓请求，起到对请求流量进行削峰的而作用。  

注意点：  
- 题目最终有应该生成为图片格式，并且在图片中加入干扰元素。  
- 答题系统为一个用户返回一个题目的时候要记录当下的时间，用于限制非法用户答题的时间，如果小于 1s，很可能不是人 

### 库存
秒杀系统中的一致性问题，最突出的就是 "减库存"的问题

#### 下单减库存
这种方式最容易控制。但如果有人下单不付款，就会有剩余库存。   

先创建订单但是先不生效，然后减库存，如果减库存成功后再生效订单，否则订单不生效。  
  
会有恶意下单占用库存，这个问题需要结合安全和反作弊的措施解决，或给商品设置最大购买件数，限制重复下单不付款的操作次数。  

秒杀系统中不付款的情况较少，这种方式是比较适合的。
#### 付款减库存
下单时不减库存，在真正付款成功时，才减库存，如果并发高，可能会出现下单后付不了款的情况  

存在的问题： 
- 会超卖，导致有的用户下单成功了，但支付失败，体验较差

#### 预扣库存
用户下单后，预扣库存，库存为其保留 5分钟，超时未支付，库存会被释放，释放后其他用户可以继续购买。用户付款时，会校验该订单的库存是否还在保留期，
如果没有保留，需要重新校验库存量，如果库存不足就不允许付款。如果在库存还在保留，则完成付款并实际的减去库存。

#### 优化
- 可以在 redis 中减库存；在 mysql 减库存的sql 语句中加入剩余库存 > 0 的限制
- 如果库存的逻辑简单，且商品数量较少，可以在持久化缓存系统中做减库存的操作
- Mysql 因为行锁的原因，在减库存场景下会产生大量的锁等待，甚至会拖慢整个数据库的性能，所以尽量可以把参与秒杀活动的库存数据单独放在一个库中
- 并发锁的问题，可以通过在应用层或数据库层做排队的方式缓解，减少对同一行数据进行操作的并发度

## 安全
- 接口防刷，在网关层对下单等接口按userID限流，防止重复下单
- 接入风控系统
- 防火墙防止洪水攻击