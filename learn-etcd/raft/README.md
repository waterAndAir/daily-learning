# 理解分布式日志一致性算法 Raft
循序渐进，由浅入深的理解 raft 
## Replicated state machines (复制状态机)  

`一个状态机`从"初始"状态开始，每一个"输入"都被传入"转换函数"和"输出函数"，以生成一个新的状态和输出。
在新的输入被接收到前，状态保持不变，而输出同时被传输给恰当的接受者。  

`复制状态机` 就是同时有多个同样的状态机,使它们让一个状态机一样, 从"初始状态"开始,经历相同的输入后达到同样的状态和`相同序列`的输出结果.  

一致性算法就是用来保证`复制状态机`的按照预期正确运行,即使某个状态机在运行过程中宕机,在它恢复运行后,依然可以保证它的状态和输出序列与正常的状态机相同.

复制状态机具有以下特性:
- 安全性: 在非[拜占庭错误](https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)(网络节点中没有破坏者)情况下，包括网络延迟、分区、丢包、冗余和乱序等错误都可以保证正确。
- 可用性: 集群中只要有大多数的机器可运行并且能够相互通信、和客户端通信，就可以保证可用。
- 不依赖时序保证一致性: 不会因为物理时钟不一致或者消息延迟导致不可用
- 快速响应: 大部分节点可以快速做出响应,不会因为个别较慢节点拖慢整体性能


在 `Etcd` 这个项目中, `复制状态机` 就是`kv`存储模块, 运行在多个节点上的 etcd kv 存储,在一致性算法 raft 模块的支持下,实现了复制状态机的
特性.  

## Raft 协议的简单流程
raft 协议从设计开始就将通俗易懂作为其目标之一，为此它将一致性问题分解成了几个相对独立的问题：领导者选举，日志复制，日志压缩，安全性和角色改变，
这些在后面会分别详细讲到。  

首先先来认识一下 raft 协议中的三种角色：  
- 领导者（Leaders）：接收来自客户端的请求，向其它节点发送日志集合和心跳请求
- 跟随者（Followers）：接收来自领导者和候选人的请求，并做出相应响应，跟随者只能做出响应，不会发出请求。当长时间接收不到领导者的心跳，等待一段时间后（election timeout），跟随者会切换到候选人状态。
- 候选人（Candidates）：向其它节点发投票请求，为自己拉选票，如果接收到大多数节点的选票，就将状态转变为领导者，如果接收到新的领导人的日志请求，就转变为跟随者






TODO: 流程图




## Raft 协议下节点的三种状态
### 领导者

### 跟随者

### 候选人

## 关键变量解释

**在所有服务器上持久存在的:**  
- `currentTerm` 服务器最后一次知道的任期号(初始化为 0, 持续递增)
- `votedFor` 在当前获得选票的候选人ID 
- `log[]` 日志集合(log entries), 每一个 entry 包含一个 

