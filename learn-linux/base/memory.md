## 内存

### 基本概念
#### 内存映射
- 物理内存只有内核能访问到，进程想要申请内存，需要借助内核为进程提供的独立的虚拟内存空间。而虚拟内存和物理内存是通过内存映射管理的。    
- 内核为每个进程维护了一个`页表`，上面记录了`虚拟内存地址`和`物理内存地址的映射关系。`
- 当进程在通过虚拟内存地址访问内存使，如果在`页表`中找不到对应的`物理内存地址`， 系统会产生一个`缺页异常`，进入内核空间分配物理内存、更新进程页表，最后再返回用户空间，恢复进程的运行。
- 内存映射规定了最小单位为 4kb， 所以每次内存映射关联的内存是 4kb 或 4kb 的整数倍。
#### 虚拟内存空间的结构
- 只读段：包括代码和常量等。
- 数据段：包括全局变量等。
- 堆：包括动态分配的内存，从低地址开始向上增长。
- 文件映射段：包括动态库、共享内存等，从高地址开始向下增长。
- 栈：包括局部变量和函数调用的上下文等。栈的大小是固定的，一般是 8 MB。
#### 内存分配与回收
##### malloc() 分配
有两种方式：
- brk(): 分配小块内存(小于128k), 释放后会缓存而不是立即归还给系统。频繁的内存分配和释放会造成内存碎片
- mmap(): 分配大块内存(大于128k)，释放后立即归还给系统。内核管理负担大。

##### 回收方式
- LRU 回收缓存
- swap 将不常访问的内存写到磁盘
- OOM

### Buffer/Cache
- buffer 是对磁盘数据的缓存；
- cache 是对文件数据的缓存；

`读写普通文件时，会经过文件系统，有文件系统负责与磁盘交互；而读写磁盘或分区时，会跳过文件系统；`

